<!DOCTYPE html>
<html lang="es">
<head>
  <!-- Meta Pixel Code -->
<script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '3997634023847682');
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=3997634023847682&ev=PageView&noscript=1"
/></noscript>
<!-- End Meta Pixel Code -->

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>GO APPLE â€” Formulario</title>
<style>
  :root{ --bg:#ffffff; --surface:#ffffff; --line:#e6e6e9; --ink:#1d1d1f; --muted:#6e6e73; --accent:#0071e3; --radius:16px; }
  *{box-sizing:border-box} html,body{height:100%}
  body{ margin:0; background:linear-gradient(180deg,#f7f8fb,#eef1f6); color:var(--ink);
        font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display",Segoe UI,Roboto,Helvetica,Arial,sans-serif;
        display:grid; place-items:center; padding:18px; }
  .card{ width:min(640px,94vw); background:var(--surface); border:1px solid var(--line); border-radius:var(--radius);
         box-shadow:0 20px 60px rgba(0,0,0,.10); overflow:hidden; }
  header{ padding:20px 22px 0; text-align:center; }
  h1{ margin:0; font-size:24px; font-weight:800; } 
  p.lead{ margin:8px 0 16px; color:#424245; font-size:15px; }
  .form-body{ padding:18px; display:grid; gap:14px; } .row{ display:grid; gap:10px; }
  label{ font-size:13px; color:#424245; font-weight:600; }
  input,select{ width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--line); background:#fafafa; font-size:14px; outline:none; }
  input[type="email"]:invalid{ border-color:#ffb4b4; }
  .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:4px; }
  .btn{ appearance:none; padding:11px 16px; border-radius:999px; font-weight:700; cursor:pointer; border:1px solid #cfd2d8; background:#fff; }
  .btn.primary{ background:var(--accent); color:#fff; border-color:var(--accent); } .btn:hover{ filter:brightness(.98); }
  .hidden{ display:none !important; } 
  footer.note{ padding:0 18px 18px; color:#6e6e73; font-size:12.5px; text-align:center; }

  /* Mensaje final (cuando elijan "< 300k") */
  .final-wrap{ padding:26px 22px 28px; text-align:center; }
  .final-emoji{ font-size:42px; }
  .final-title{ margin:10px 0 6px; font-size:22px; font-weight:800; }
  .final-text{ margin:0 auto; max-width:520px; color:#424245; font-size:15px; line-height:1.45; }
  .final-badge{ display:inline-block; margin-top:14px; padding:6px 12px; border-radius:999px; background:#eff6ff; color:#1e40af; font-weight:700; font-size:12.5px; border:1px solid #dbeafe; }
  .final-ok{ margin-top:16px; padding:10px 16px; border-radius:999px; border:1px solid #cfd2d8; background:#fff; font-weight:700; cursor:default; color:#1d1d1f; }
</style>
</head>
<body>
<main class="card" role="dialog" aria-modal="true" aria-labelledby="form-title">
  <header id="hdr">
    <h1 id="form-title">ðŸ”¥ GanÃ¡ 10% de Descuento ðŸ”¥</h1>
    <p class="lead" id="form-lead">CompletÃ¡ el formulario y accedÃ© a un <strong>10% OFF</strong> en tu prÃ³ximo iPhone.</p>
  </header>

  <section class="form-body" id="form-body">
    <!-- Paso 1 -->
    <div id="step1" class="row">
      <div>
        <label for="lf-name">Nombre</label>
        <input id="lf-name" type="text" placeholder="Tu nombre" autocomplete="name" />
      </div>
      <div>
        <label for="lf-email">Correo</label>
        <input id="lf-email" type="email" placeholder="tu@email.com" autocomplete="email" required />
      </div>
      <div>
        <label for="lf-phone">WhatsApp</label>
        <input id="lf-phone" type="tel" placeholder="+54 9 ..." inputmode="tel" autocomplete="tel" />
      </div>
      <div class="actions">
        <button class="btn" id="cancel">Cancelar</button>
        <button class="btn primary" id="next">Continuar</button>
      </div>
    </div>

    <!-- Paso 2 -->
    <div id="step2" class="row hidden">
      <div>
        <label for="lf-budget">Â¿CuÃ¡l es tu inversiÃ³n (ARS)?</label>
        <select id="lf-budget">
          <option value="menos">Menos de $300.000</option>
          <option value="400-600">$400.000 a $600.000</option>
          <option value="700-900">$700.000 a $900.000</option>
          <option value="mas900">MÃ¡s de $900.000</option>
        </select>
      </div>
      <div class="actions">
        <button class="btn" id="back">Volver</button>
        <button class="btn primary" id="send">Enviar</button>
      </div>
    </div>
  </section>

  <footer class="note" id="note">Completando el formulario obtenÃ©s tu beneficio del 10% OFF.</footer>
</main>

<script>
(function(){
  const KEY='lead_form_done_v1';
  const KEY_LOW='lead_low_budget_v1';

  const $hdr=document.getElementById('hdr');
  const $body=document.getElementById('form-body');
  const $note=document.getElementById('note');

  const $s1=document.getElementById('step1');
  const $s2=document.getElementById('step2');
  const $name=document.getElementById('lf-name');
  const $mail=document.getElementById('lf-email');
  const $tel=document.getElementById('lf-phone');
  const $bud=document.getElementById('lf-budget');

  // Si ya quedÃ³ marcado presupuesto bajo en esta sesiÃ³n, mostrar mensaje final
  if (sessionStorage.getItem(KEY_LOW) === '1') {
    renderFinalMessage();
    disableFormForever();
  }

  // Validaciones robustas (UNA sola barra en el HTML final)
  const EMAIL_RE=/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;
  const emailOk=v=> EMAIL_RE.test((v||'').trim()) && $mail.checkValidity();
  const phoneOk=v=> ((v||'').match(/\\d/g) || []).length >= 8;

  const requiredFilled=()=> ($name.value||'').trim() && emailOk($mail.value) && phoneOk($tel.value);

  // RecolecciÃ³n de UTM
  function collectUTMs(){
    const q = new URLSearchParams(location.search);
    return {
      utm_source:  q.get('utm_source')  || '',
      utm_medium:  q.get('utm_medium')  || '',
      utm_campaign:q.get('utm_campaign')|| '',
    };
  }

  // Enviar al webhook sin bloquear la UX
  async function pushToSheet(payload){
    try{
      if (navigator.sendBeacon) {
        const ok = navigator.sendBeacon('https://primary-production-639e.up.railway.app/webhook/goapple-leads', new Blob([JSON.stringify(payload)], {type:'application/json'}));
        if (ok) return true;
      }
    }catch(_){}

    const controller = new AbortController();
    const t = setTimeout(()=>controller.abort(), 3500);
    try{
      await fetch('https://primary-production-639e.up.railway.app/webhook/goapple-leads', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload),
        keepalive: true,
        signal: controller.signal
      });
    }catch(_){}
    clearTimeout(t);
    return true;
  }

  // NavegaciÃ³n
  document.getElementById('next').onclick=()=>{
    if(!requiredFilled()){
      alert('CompletÃ¡ nombre, correo y WhatsApp vÃ¡lidos.');
      return;
    }
    $s1.classList.add('hidden'); $s2.classList.remove('hidden'); $bud.focus();
  };
  document.getElementById('back').onclick=()=>{ $s2.classList.add('hidden'); $s1.classList.remove('hidden'); };
  document.getElementById('cancel').onclick=()=>{ history.back(); };

  // RedirecciÃ³n al catÃ¡logo (incluye query opcional)
  function goCatalog(){
    const target = new URL('https://goapple-catalogo.vercel.app/');
    const qs = new URLSearchParams({
      name: ($name.value||'').trim(),
      email: ($mail.value||'').trim(),
      phone: ($tel.value||'').trim(),
      budget: $bud.value
    });
    target.search = qs.toString();
    window.location.href = target.toString();
  }

  // UI para presupuesto bajo
  function renderFinalMessage(){
    $hdr.innerHTML = '<div class="final-wrap"><div class="final-emoji">ðŸ‘‹</div><h2 class="final-title">Â¡Gracias por tu interÃ©s!</h2><p class="final-text">Por el momento no contamos con stock dentro de ese presupuesto. En breve ingresan iPhones nuevos ðŸ“². Te voy a contactar apenas tengamos disponibilidad para que aproveches tu <strong>10% OFF</strong>.</p><span class="final-badge">Tu solicitud quedÃ³ registrada</span><div><button class="final-ok" aria-disabled="true">Entendido</button></div></div>';
    $body.remove();
    $note.textContent = 'Nos pondremos en contacto automÃ¡ticamente ni bien haya disponibilidad.';
  }

  function disableFormForever(){
    sessionStorage.setItem(KEY,'1');
    sessionStorage.setItem(KEY_LOW,'1');
    try {
      history.pushState({blocked:true}, '');
      window.addEventListener('popstate', ()=>{
        if (sessionStorage.getItem(KEY_LOW) === '1') history.pushState({blocked:true}, '');
      });
    } catch(_) {}
  }

  // Submit
  document.getElementById('send').onclick=async ()=>{
    const name=($name.value||'').trim();
    const email=($mail.value||'').trim();
    const phone=($tel.value||'').trim();
    const budget=($bud.value||'').trim();

    if(!name || !emailOk(email) || !phoneOk(phone)){
      alert('CompletÃ¡ nombre, correo y WhatsApp vÃ¡lidos.');
      return;
    }

    // Evitar doble click
    const btn=document.getElementById('send');
    btn.disabled=true; btn.textContent='Enviando...';

    // Guardar en URL local
    const params=new URLSearchParams(location.search);
    params.set('name',name); params.set('email',email); params.set('phone',phone); params.set('budget',budget);
    history.replaceState({},'',location.pathname+'?'+params.toString());
    sessionStorage.setItem(KEY,'1');

    // Enviar al webhook (no bloquea)
    const utm = collectUTMs();
    const payload = {
      timestamp: new Date().toISOString(),
      name, email, phone, budget,
      ...utm,
      page: location.href,
      user_agent: navigator.userAgent
    };
    pushToSheet(payload);

    try{ if(window.fbq){ fbq('track','Lead',{ value: budget, currency:'ARS' }); } }catch(_){}

    if(budget==='menos'){
      renderFinalMessage();
      disableFormForever();
      return;
    }

    if(budget==='400-600' || budget==='700-900' || budget==='mas900'){
      goCatalog();
    } else {
      alert('Â¡Gracias! Ya ganaste tu 10% OFF ðŸŽ‰');
    }
  };
})();
</script>
</body>
</html>