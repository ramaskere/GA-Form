<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>GO APPLE — Formulario</title>

  <!-- ✅ Meta Pixel Code (ID real del cliente) -->
  <script>
  !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
  n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');
  fbq('init','650415544428771');
  fbq('track','PageView');
  </script>
  <noscript>
    <img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=650415544428771&ev=PageView&noscript=1"/>
  </noscript>
  <!-- ✅ End Meta Pixel Code -->

  <style>
    :root{ --bg:#f7f8fb; --surface:#fff; --line:#e5e7eb; --ink:#1d1d1f; --accent:#0071e3; }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      display:grid; place-items:center; padding:20px;
    }
    .card{
      width:min(640px,95vw); background:var(--surface); border:1px solid var(--line);
      border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.12); padding:24px 22px;
    }
    h1{ margin:0 0 8px; font-size:24px; font-weight:800; text-align:center; }
    p.lead{ text-align:center; color:#424245; margin:0 0 22px; }
    form{ display:grid; gap:14px; }
    label{ font-size:14px; font-weight:700; }
    input,select{
      width:100%; padding:12px 14px; border:1px solid var(--line); border-radius:12px;
      background:#fafafa; font-size:14px; outline:none;
    }
    button{
      padding:12px 16px; border-radius:999px; border:0; font-weight:800;
      background:var(--accent); color:#fff; cursor:pointer;
    }
    button[disabled]{ opacity:.7; cursor:not-allowed; }
    .note{ margin-top:8px; text-align:center; color:#6b7280; font-size:12.5px; }

    /* Mensaje final si presupuesto es "menos" */
    .final-wrap{ text-align:center; padding:18px 6px; }
    .final-emoji{ font-size:40px; }
    .final-title{ margin:10px 0 6px; font-size:22px; font-weight:800; }
    .final-text{ margin:0 auto; max-width:520px; color:#424245; font-size:15px; line-height:1.45; }
    .final-badge{ display:inline-block; margin-top:14px; padding:6px 12px; border-radius:999px;
                  background:#eff6ff; color:#1e40af; font-weight:700; font-size:12.5px; border:1px solid #dbeafe; }
    .hide{ display:none !important; }
  </style>
</head>
<body>
  <div class="card" id="card">
    <h1>🔥 Ganá 10% de Descuento 🔥</h1>
    <p class="lead">Completá el formulario y accedé a un <strong>10% OFF</strong> en tu próximo iPhone.</p>

    <!-- ✅ Formulario -->
    <form id="leadForm" autocomplete="on">
      <div>
        <label for="nombre">Nombre</label>
        <input type="text" name="nombre" id="nombre" required />
      </div>
      <div>
        <label for="telefono">WhatsApp</label>
        <input type="tel" name="telefono" id="telefono" required />
      </div>
      <div>
        <label for="presupuesto">¿Cuál es tu presupuesto?</label>
        <select name="presupuesto" id="presupuesto" required>
          <option value="">Seleccioná</option>
          <option value="menos">Menos de $300.000</option>
          <option value="400-600">$400.000 a $600.000</option>
          <option value="700-900">$700.000 a $900.000</option>
          <option value="mas900">Más de $900.000</option>
        </select>
      </div>
      <div>
        <label for="modelo">Modelo de interés</label>
        <input type="text" name="modelo" id="modelo" placeholder="Ej: iPhone 14 Pro" />
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <div>
          <label for="ciudad">Ciudad</label>
          <input type="text" name="ciudad" id="ciudad" />
        </div>
        <div>
          <label for="pais">País</label>
          <input type="text" name="pais" id="pais" />
        </div>
      </div>
      <div>
        <label for="califica">¿Califica?</label>
        <select name="califica" id="califica">
          <option value="">Seleccioná</option>
          <option value="si">Sí</option>
          <option value="no">No</option>
        </select>
      </div>

      <button type="submit" id="btnSend">Enviar</button>
      <div class="note">Al enviar, registramos tus datos y podrás usar tu beneficio del 10% OFF.</div>
    </form>

    <!-- Contenedor para mensaje final -->
    <div id="finalMsg" class="hide"></div>
  </div>

  <!-- ✅ Lógica del formulario, envío a Apps Script, Meta Pixel y WhatsApp -->
  <script>
  (function(){
    const WEBHOOK = 'https://script.google.com/macros/s/XXXXXXXX/exec'; // ⬅️ Reemplazá por tu Apps Script Web App
    const WA_NUMBER = '5492646721845'; // wa.me sin + ni espacios (tu número)
    const WA_MSG = '👋 ¡Hola! Tengo un cupón de 10% de descuento';

    const $form = document.getElementById('leadForm');
    const $btn  = document.getElementById('btnSend');
    const $final= document.getElementById('finalMsg');
    const $card = document.getElementById('card');

    // Helpers simples (evitamos regex para no romper n8n)
    const hasMinDigits = (s, n=8) => ((s||'').replace(/\\D/g,'').length >= n);

    function estimateValue(b) {
      if (b === '400-600') return 500000;
      if (b === '700-900') return 800000;
      if (b === 'mas900')  return 1000000;
      return 0;
    }

    function goWhatsApp(){
      const url = 'https://wa.me/' + WA_NUMBER + '?text=' + encodeURIComponent(WA_MSG);
      // replace -> no pueden volver atrás a cambiar presupuesto
      location.replace(url);
    }

    function showFinal(){
      const html = [
        '<div class="final-wrap">',
          '<div class="final-emoji">👋</div>',
          '<div class="final-title">¡Gracias por tu interés!</div>',
          '<p class="final-text">Por el momento no contamos con stock dentro de ese presupuesto.',
          ' En breve ingresan iPhones nuevos 📲. Te voy a contactar apenas tengamos disponibilidad ',
          'para que aproveches tu <strong>10% OFF</strong>.</p>',
          '<span class="final-badge">Tu solicitud quedó registrada</span>',
        '</div>'
      ].join('');
      $final.innerHTML = html;
      $final.classList.remove('hide');
      $form.classList.add('hide');
      try {
        history.pushState({blocked:true}, '');
        window.addEventListener('popstate', ()=> history.pushState({blocked:true}, ''));
      } catch(_) {}
    }

    $form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const fd = new FormData($form);
      const nombre      = (fd.get('nombre')||'').trim();
      const telefono    = (fd.get('telefono')||'').trim();
      const presupuesto = (fd.get('presupuesto')||'').trim();
      const modelo      = (fd.get('modelo')||'').trim();
      const ciudad      = (fd.get('ciudad')||'').trim();
      const pais        = (fd.get('pais')||'').trim();
      const califica    = (fd.get('califica')||'').trim();

      if (!nombre || !presupuesto || !hasMinDigits(telefono, 8)) {
        alert('Completá nombre, un WhatsApp válido y elegí un presupuesto.');
        return;
      }

      $btn.disabled = true; $btn.textContent = 'Enviando...';

      const payload = {
        nombre, telefono, presupuesto, modelo, ciudad, pais, califica,
        origen: 'goapple-form',
        timestamp: new Date().toISOString(),
        page: location.href,
        user_agent: navigator.userAgent
      };

      // Enviar a Google Apps Script (si hay CORS usar mode:'no-cors' y quitar headers)
      try {
        await fetch(WEBHOOK, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
          // Si ves error CORS, probá: mode: 'no-cors' y sin headers
        });
      } catch (e) { console.warn('Webhook error:', e); }

      // Disparar eventos Meta (Lead + InitiateCheckout si califica)
      try {
        if (window.fbq) {
          const valueARS = estimateValue(presupuesto);
          fbq('track','Lead',{
            value: valueARS, currency: 'ARS',
            content_category:'iphone', content_name:'lead_form'
          });
          if (presupuesto !== 'menos') {
            fbq('track','InitiateCheckout',{
              value: valueARS, currency: 'ARS',
              num_items:1, content_category:'iphone', content_name:'lead_qualificado'
            });
          }
        }
      } catch(_) {}

      // Ramas de negocio
      if (presupuesto === 'menos') {
        showFinal();
        return;
      }

      // Califica → WhatsApp directo (pequeña espera para que el Pixel despache)
      setTimeout(()=> goWhatsApp(), 250);
    });
  })();
  </script>
</body>
</html>